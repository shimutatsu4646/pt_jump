<div class="text-center">
  <h3>トレーナー検索</h3>
  <% if @trainer_search_params.present? %>
    <button class="btn btn-outline-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSearch" aria-expanded="false" aria-controls="collapseSearch">
      検索フォームを表示する
    </button>
  <% end %>
  <div class="collapse <%= "show" if @trainer_search_params.blank? %> card" id="collapseSearch">
    <div class="card-body">
      <h6 class="mb-4">※絞り込みを行わない項目は空白の状態にしてください。</h6>
      <%= form_with(scope: :search_trainer, url: search_for_trainer_path, method: :get) do |f| %>
        <div class="search_field">
          <%= f.label :age, "年齢の範囲" %><br />
          <%= f.number_field :age_from, value: @trainer_search_params[:age_from] %>歳以上
          <%= f.number_field :age_to, value: @trainer_search_params[:age_to] %>歳以下
        </div>

        <div class="search_field">
          <%= f.label :gender, "性別" %><br />
          <%= f.select :gender, Trainer.genders_i18n.keys.map {|k| [I18n.t("enums.trainer.gender.#{k}"), k]}, { include_blank: true, selected: @trainer_search_params[:gender] } %>
        </div>

        <div class="search_field">
          <%= f.label :category, "カテゴリー" %><br />
          <%= f.select :category, Trainer.categories_i18n.keys.map {|k| [I18n.t("enums.trainer.category.#{k}"), k]}, { include_blank: true, selected: @trainer_search_params[:category] } %>
        </div>

        <div class="search_field">
          <%= f.label :instruction_method, "希望している指導方法" %><br />
          <%= f.select :instruction_method, Trainer.instruction_methods_i18n.keys.map {|k| [I18n.t("enums.trainer.instruction_method.#{k}"), k]}, { include_blank: true, selected: @trainer_search_params[:instruction_method] } %>
        </div>

        <div class="search_field">
          <%= f.label :instruction_period, "希望している指導期間" %><br />
          <%= f.select :instruction_period, Trainer.instruction_periods_i18n.keys.map {|k| [I18n.t("enums.trainer.instruction_period.#{k}"), k]}, { include_blank: true, selected: @trainer_search_params[:instruction_period] } %>
        </div>

        <div class="search_field">
          <%= f.label :age, "最低料金の範囲" %><br />
          <%= f.number_field :min_fee_from, value: @trainer_search_params[:min_fee_from] %>円以上
          <%= f.number_field :min_fee_to, value: @trainer_search_params[:min_fee_to] %>円以下
        </div>

        <div class="search_field">
          <%= f.label :city_ids, "活動している地域" %><br />
          <div class="row justify-content-center mt-3">
            <% Region.all.each do |region| %>
                <button type= "button" class="btn btn-outline-dark btn-lg m-1 col-4" data-bs-toggle="collapse" data-bs-target="#prefectureCollapse<%= region.id %>" aria-expanded="false">
                  <%= region.name %>
                </button>
              <div class="collapse m-3" id="prefectureCollapse<%= region.id %>">
                <% Prefecture.where(region_id: region.id).each do |prefecture| %>
                  <% if region.id == prefecture.region_id %>
                    <button type= "button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#cityCollapse<%= prefecture.id %>" aria-expanded="false">
                      <%= prefecture.name %>
                    </button>
                  <% end %>
                  <div class="collapse m-2" id="cityCollapse<%= prefecture.id %>">
                    <% i = 0 %>
                  <div class="border border-secondary border-2 bg-light p-2 mt-4"><%= prefecture.name %>の市区町村の一覧</div>
                    <%= f.collection_check_boxes :city_ids, City.all, :id, :name, {checked: @trainer_search_params[:city_ids]} do |city| %>
                      <% if prefecture.id == city.object.prefecture_id %>
                        <% if i % 3 == 0 %>
                          <br>
                        <% end %>
                        <% i += 1 %>
                        <span class="mx-2 my-3"><%= city.check_box + city.text %></span>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
        <div class="actions">
          <%= f.submit 'この条件で検索する', class: "btn btn-outline-primary btn-lg" %>
        </div>
      <% end %>
      <%= button_to "検索条件・検索結果をリセットする", search_for_trainer_path, method: :get, class: "btn btn-outline-warning" %>
    </div>
  </div>
  <% if @trainer_search_params.present? %>
    <h6>条件に一致するトレーナーは<%= @trainers.count %>件です。</h6>
  <% end %>
</div>

<div class="container">
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3">
    <% if @trainer_search_params.present? %>
      <% @trainers.each do |trainer| %>
        <ul class="custom-light-gray col pb-2 border border-3 border-white search-result">
          <li><%= image_tag trainer.avatar.variant(gravity: :center, resize:"200x200^", crop:"200x200+0+0").processed, class: "avatar_image" %></li>
          <li>名前：<%= trainer.name %></li>
          <li>年齢：<%= trainer.age %>歳</li>
          <li>性別：<%= trainer.gender_i18n %></li>
          <li>カテゴリー：<% if trainer.category %><%= trainer.category_i18n %><% else %>指定なし<% end %></li>
          <li>指導方法：<% if trainer.instruction_method %><%= trainer.instruction_method_i18n  %><% else %>指定なし<% end %></li>
          <li>指導期間：<%= trainer.instruction_period_i18n %></li>
          <li>最低料金：<% if trainer.min_fee %><%= trainer.min_fee %>円<% else %>指定なし<% end %></li>
          <li>活動地域<% if trainer.prefectures.empty? %>：<button type="button" class="btn btn-sm btn-secondary" disabled>入力なし</button><% end %></li>
          <% trainer.prefectures.distinct.each do |prefecture| %>
            <li>
              <%= prefecture.name %>：
              <button class="btn btn-outline-dark btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= trainer.id %>and<%= prefecture.id %>" aria-expanded="false" aria-controls="collapse<%= trainer.id %>and<%= prefecture.id %>">
                活動している市区町村
              </button>
            </li>
            <div class="collapse" id="collapse<%= trainer.id %>and<%= prefecture.id %>">
              <div class="card card-body">
                <p class="row row-cols-2 row-cols-md-3 row-cols-lg-3">
                <% trainer.cities.where(prefecture_id: prefecture.id).each do |city| %>
                  <span class="col"><%= city.name %></span>
                <% end %>
                </p>
              </div>
            </div>
          <% end %>
          <%= button_to "このトレーナー詳細を見る", trainer_path(trainer), method: :get, class: "btn btn-outline-primary" %>
        </ul>
      <% end %>
    <% end %>
  </div>
</div>
